<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSV to Stacked Area Chart</title>
    <style>
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0.9;
        }
    </style>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <div id="chart"></div>
    <script>
        Promise.all([
            d3.csv("info.csv"),
            d3.csv("nivo.csv")
        ]).then(([infoData, nivoData]) => {
            processData(infoData, nivoData);
        });

        function processData(infoData, nivoData) {
            // Convert nivoData to a lookup map based on numer_sta
            const nivoMap = {};
            nivoData.forEach(d => {
                nivoMap[d.numer_sta] = +d.ht_neige;
            });
            neigeData = infoData;
            // Parse and sort the infoData
            neigeData.forEach(d => {
                d.Latitude = +d.Latitude;
                d.Longitude = +d.Longitude;
                d.Altitude = +d.Altitude;
                d.ht_neige = nivoMap[d.ID]*200 || 0; // Add ht_neige from nivoMap
            });
            neigeData = neigeData.filter(d => d.ht_neige != 0); // Filter out zero ht_neige

            neigeData.sort((a, b) => a.Altitude - b.Altitude);

            // Prepare data for stacking
            const stackData = neigeData.map((d, i) => ({
                index: i,
                Altitude: d.Altitude,
                ht_neige: d.ht_neige,
                Latitude: d.Latitude,
                Longitude: d.Longitude,
                ID: d.ID,
                Nom: d.Nom
            }));

            // Create the stacked area chart with interactivity
            createStackedAreaChart(stackData);
        }

        function createStackedAreaChart(data) {
            const margin = { top: 20, right: 30, bottom: 30, left: 50 };
            const width = 928 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            const x = d3.scaleLinear()
                .domain([0, data.length - 1])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.Altitude + d.ht_neige)]) // Adjust for visualization
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(["Altitude", "ht_neige"])
                .range(["brown", "blue"]);

            const stack = d3.stack()
                .keys(["Altitude", "ht_neige"]);

            const series = stack(data);

            const area = d3.area()
                .x((d, i) => x(i))
                .y0(d => y(d[0]))
                .y1(d => y(d[1])); // Adjust ht_neige for visualization

            svg.selectAll(".layer")
                .data(series)
                .enter().append("path")
                .attr("class", "layer")
                .attr("fill", d => color(d.key))
                .attr("d", area)
                .on("mouseover", function(event, d) {
                    const [mouseX, mouseY] = d3.pointer(event);
                    const x0 = x.invert(mouseX);
                    const i = Math.round(x0);
                    const dataPoint = data[i];
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    tooltip.html(`ID: ${dataPoint.ID}<br>Nom: ${dataPoint.Nom}<br>Altitude: ${dataPoint.Altitude}<br>ht_neige: ${dataPoint.ht_neige}`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(data.length));

            svg.append("g")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(d => d))
                .selectAll(".tick line").attr("stroke-opacity", 0.1);

            svg.append("line")
                .attr("x1", 0)
                .attr("x2", width)
                .attr("y1", y(0))
                .attr("y2", y(0))
                .attr("stroke", "black");

            // Log the series to verify the stacking
            console.log(series);
        }
    </script>
</body>
</html>
